<h1>New event</h1>

<%= render 'form' %>

<%= link_to 'Cancel', events_path, :class=>"btn" %>
<script type="text/javascript">
	$(document).ready(function(){
		$("#readable_start_date").datetimepicker({
		dateFormat: 'mm/dd/yy',
		timeFormat: 'hh:mm:ss TT',
		timezoneList: [ 
			{ value: '-0700', label: 'Pacific' } 
		],
		onClose: function(){
			if ($.trim($(this).val()).length > 0){
				var millis = Date.parse($(this).val()), oneDayMillis = 86400000, threeHoursMillis = 10800000, end_date = $("#readable_end_date"), rsvp_date = $("#readable_rsvp_date");
				if ($.trim(end_date.val()).length == 0){
					end_date.val(convertDatesToReadableClient(new Date(millis+threeHoursMillis)))
				}
				if ($.trim(rsvp_date.val()).length == 0){
					rsvp_date.val(convertDatesToReadableClient(new Date(millis-oneDayMillis)));
				}
			}
		}
		});

		$("#readable_end_date").datetimepicker({
		dateFormat: 'mm/dd/yy',
		timeFormat: 'hh:mm:ss TT',
		timezoneList: [ 
			{ value: '-0700', label: 'Pacific' } 
		]
		});

		$("#readable_rsvp_date").datetimepicker({
		dateFormat: 'mm/dd/yy',
		timeFormat: 'hh:mm:ss TT',
		timezoneList: [ 
			{ value: '-0700', label: 'Pacific' } 
		]
		});

		function convertDatesToReadableClient(dateObject){
			var datePortion = dateObject.toLocaleDateString(),
					timePortion = dateObject.toLocaleTimeString();

			if (timePortion.indexOf(":") == 1){
				return datePortion+" 0"+timePortion;
			} else {
				return datePortion+" "+timePortion;
			}
		}

		function loadClientDatesFromServer(){
			var startDateFromModel = $("#start_date");
			var rsvpDateFromModel = $("#rsvp_date");
			var endDateFromModel = $("#end_date");
			if ($.trim(startDateFromModel.val()).length > 0){
				$("#readable_start_date").val(convertDatesToReadableClient(new Date(startDateFromModel.val())));
			}
			if ($.trim(rsvpDateFromModel.val()).length > 0){
				$("#readable_rsvp_date").val(convertDatesToReadableClient(new Date(rsvpDateFromModel.val())));
			}
			if ($.trim(endDateFromModel.val()).length > 0){
				$("#readable_end_date").val(convertDatesToReadableClient(new Date(endDateFromModel.val())));
			}
		}

		function convertDatesForServer(clientSideDate, element){
			if ($.trim(clientSideDate) != 0){
				var dateInMillis = Date.parse(clientSideDate);
				var dateObject = new Date(dateInMillis);
				$(element).val(dateObject.toUTCString());
			} else {
				$(element).val("");
			}
		}

		loadClientDatesFromServer();

		$("#event_submit").click(function(){
			convertDatesForServer($("#readable_start_date").val(), $("#start_date"));
			convertDatesForServer($("#readable_rsvp_date").val(), $("#rsvp_date"));
			convertDatesForServer($("#readable_end_date").val(), $("#end_date"));
		});
	});
</script>
