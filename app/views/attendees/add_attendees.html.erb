<div id="alert-flash">
</div>
<div class="row">
	<div class="span8 offset1">
			<div id="form-proxy">
				<div class="input-prepend" style="display:block"><span class="add-on"><i class="icon-envelope"></i></span>
					<input type="text" class="input-large" placeholder="Email">
				</div>
			</div>
	</div>
	<div class="span9 offset1">
			<button id="add-more" class="btn btn-success">Add more ...</button>
			<button id="send-invitations" class="btn btn-primary">Send</button>
	</div>
</div>
<form accept-charset="UTF-8" action="" class="form-horizontal" method="post">
		<input type="hidden" name="email_invites" id="email_invites" value="" >
</form>
<script>
  $(document).ready(function(){
		$("#add-more").click(function(){
			var form = $("#form-proxy");
			var additionalDiv = $("<div class='input-prepend' style='display:block'></div>");
			var emailIcon = $("<span class='add-on'><i class='icon-envelope'></i></span>");
			var emailText = $("<input type='text' class='input-large' placeholder='Email'>");
			var removeButton = $("<button class='btn btn-small btn-danger' style='margin-bottom:0.5em;margin-left:0.5em'>Remove</button>");
			removeButton.click(function(){
				additionalDiv.remove();
			});
			emailText.click(function(){
				$(this).removeAttr('style');
			});
			additionalDiv.appendTo(form);
			emailIcon.appendTo(additionalDiv);
			emailText.appendTo(additionalDiv);
			removeButton.appendTo(additionalDiv);
		});

		$("#send-invitations").click(function(){
			var outputJSON = {};
			var emailArray = [];
			$(".input-large").each(function(index, data){
					var value = $(data).val();
					if ($.trim(value).length == 0){
						$(data).css('background-color','red');
						return true;
					}
					emailArray.push(value);
			});
			if ( $(".input-large[style]").length > 0){
				var count = $(".input-large[style]").length;
				$("#alert-flash").addClass("alert alert-error");
				$("#alert-flash").text("There are currently "+count+" blank email entries. Please either remove them or populate them.");
			}
			else {
				outputJSON["email"] = emailArray;
				$("#email_invites").val(JSON.stringify(outputJSON));
				var invite_guest_link = document.location.pathname+"/attendees/invite_guests", serialized_form = $(".form-horizontal").serialize();
				$.ajax({
					url: invite_guest_link,
					type: 'POST',
					data: serialized_form,
					dataType: 'html',
					async: false,
					success: function(data){
						$("#notice").removeClass("alert alert-error alert-success").addClass("alert alert-success");
						$("#notice").html("Invitations have been sent. Take a look at your guest list to see who has been added");
						$("#invite_guests").click();
					},
					error: function() {
						$(".form-horizontal").prepend("<div class='alert alert-error'>Invitations could not be sent out! Please contact your administrator and describe how to reproduce this issue</div>");
					}
				});
				return false;
			}
		});

		//Need this for the first entry since the others are dynamically added.
		$(".input-large").click(function(){ $(this).removeAttr('style'); });
	});
</script>

